---
# Update system  Ubuntu
- name: Reboot after system have been deployed
  reboot:
    reboot_timeout: 100

- name: Update System cache [Common, Debian family]
  apt:
    upgrade: true
    update_cache: true
    cache_valid_time: 3600
  register: updatest
  tags:
    - update_system

- name: Run dpkg if needed
  command: 'dpkg --configure -a'
  register: dpkgst
  changed_when: dpkgst.rc != 2
  when: updatest.rc != 0
  
- name: Kill apt
  command: killall apt apt-get
  register: kill
  changed_when: kill.rc != 2
  ignore_errors: true

- name: Install packages
  apt:
    name: "{{ packages }}"
    state: present
